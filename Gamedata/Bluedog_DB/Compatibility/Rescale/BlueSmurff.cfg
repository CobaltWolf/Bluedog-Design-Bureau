// Based on Kerbas_ad_astra's SMURFF.
// https://github.com/Kerbas-ad-astra/SMURFF
// Simpler to roll our own than let smurff run and make adjustments.

@PART[bluedog*,Bluedog*]:NEEDS[SMURFF]
{
    %SMURFFExclude = true
}

BDBRESCALECONFIG
{
	systemScale = 1
	tankFactor = 1
	structFactor = 1
	podFactor = 1
	apolloPodFactor = 1
	engineFactor = 1
	srbIspAdd = 0
	
	ballastFactorS1C = 1
	ballastFactorS2 = 1
	ballastFactorS4B = 1
}

@BDBRESCALECONFIG:NEEDS[Sigma]:FOR[zzzBluedog_DB_0]
{
	@systemScale = #$@SigmaDimensions/Resize$
}
@BDBRESCALECONFIG:NEEDS[HarderSolarSystem-2x]:FOR[zzzBluedog_DB_0]
{
	@systemScale = 2
}
@BDBRESCALECONFIG:NEEDS[HarderSolarSystem-3x]:FOR[zzzBluedog_DB_0]
{
	@systemScale = 3
}
@BDBRESCALECONFIG:NEEDS[HarderSolarSystem-4x]:FOR[zzzBluedog_DB_0]
{
	@systemScale = 4
}

@BDBRESCALECONFIG:BEFORE[zzzBluedog_DB_1]
{
	%scaleFactor = #$systemScale$
	@scaleFactor -= 1
	@scaleFactor /= 5.4
}

@PART[bluedog*,Bluedog*]:FOR[zzzBluedog_DB_1]
{
	%bdbSystemScale = #$@BDBRESCALECONFIG/systemScale$
}

@BDBRESCALECONFIG:HAS[#systemScale[>1]]:FOR[zzzBluedog_DB_1]
{
	%podSubtract = 0.5
	@podSubtract *= #$scaleFactor$
	@podFactor -= #$podSubtract$
	%apolloPodFactor = #$podFactor$
	
	@srbIspAdd = 40
	@srbIspAdd *= #$scaleFactor$
}

@BDBRESCALECONFIG:HAS[#systemScale[>2.9]]:FOR[zzzBluedog_DB_1]
{
	%tankSubtract = 0.59
	@tankSubtract *= #$scaleFactor$
	@tankFactor -= #$tankSubtract$
}

@BDBRESCALECONFIG:HAS[#systemScale[>3.9]]:FOR[zzzBluedog_DB_1]
{
	%structSubtract = 0.50
	@structSubtract *= #$scaleFactor$
	@structFactor -= #$structSubtract$
}

@BDBRESCALECONFIG:HAS[#systemScale[>3.9]]:FOR[zzzBluedog_DB_1]
{
	%engineSubtract = 0.59
	@engineSubtract *= #$scaleFactor$
	@engineFactor -= #$engineSubtract$
}

@BDBRESCALECONFIG:HAS[#systemScale[>6]]:FOR[zzzBluedog_DB_1]
{
	%apolloPodSubtract = 0.6
	@apolloPodSubtract *= #$scaleFactor$
	@apolloPodFactor -= #$apolloPodSubtract$
	
	%ballastFactorS1C = 1
	%ballastFactorS2 = 0.5
	%ballastFactorS4B = 0.2
}


// ----


@B9_TANK_TYPE[bdb*]:FOR[zzzBluedog_DB_2]
{
	@tankMass *= #$@BDBRESCALECONFIG/tankFactor$
}

@PART[bluedog*,Bluedog*]:HAS[@MODULE[ModuleAblator],~bdbMassAdjusted[*]]:FOR[zzzBluedog_DB_2]
{
	@mass *= #$@BDBRESCALECONFIG/podFactor$
	%bdbMassAdjusted = #$@BDBRESCALECONFIG/podFactor$
	
	@RESOURCE[Ablator]
	{
		@amount *= #$@BDBRESCALECONFIG/podFactor$
		@maxAmount *= #$@BDBRESCALECONFIG/podFactor$
	}
	@MODULE[ModuleAblator]
	{
		@pyrolysisLossFactor /= #$@BDBRESCALECONFIG/podFactor$
	}
}


// ----


@PART[bluedog_mercuryLES,bluedog_mercurySRB]:HAS[~bdbMassAdjusted[*]]:FOR[zzzBluedog_DB_3]
{
	@mass *= #$@BDBRESCALECONFIG/podFactor$
	%bdbMassAdjusted = #$@BDBRESCALECONFIG/podFactor$
	%bdbSrbAdjusted = true
	
	@MODULE[ModuleEngines*]
	{
		@maxThrust *= #$@BDBRESCALECONFIG/podFactor$
	}
	@RESOURCE[SolidFuel]
	{
		@amount *= #$@BDBRESCALECONFIG/podFactor$
		@maxAmount *= #$@BDBRESCALECONFIG/podFactor$
	}
}

@PART[bluedog_mercury*]:HAS[~bdbMassAdjusted[*]]:FOR[zzzBluedog_DB_3]
{
	@mass *= #$@BDBRESCALECONFIG/podFactor$
	%bdbMassAdjusted = #$@BDBRESCALECONFIG/podFactor$
}


@PART[bluedog_Gemini_Service_A]:HAS[~bdbMassAdjusted[*]]:FOR[zzzBluedog_DB_3]
{
	@mass *= #$@BDBRESCALECONFIG/podFactor$
	%bdbMassAdjusted = #$@BDBRESCALECONFIG/podFactor$
	
	@RESOURCE[MonoPropellant]
	{
		@amount *= #$@BDBRESCALECONFIG/podFactor$
		@amount /= 2
		//@maxAmount *= #$@BDBRESCALECONFIG/podFactor$
	}
}

@PART[bluedog_Gemini*,bluedog_gemini*]:HAS[~bdbMassAdjusted[*]]:FOR[zzzBluedog_DB_3]
{
	@mass *= #$@BDBRESCALECONFIG/podFactor$
	%bdbMassAdjusted = #$@BDBRESCALECONFIG/podFactor$
}


@PART[bluedog_Apollo_Block2_LES]:HAS[~bdbMassAdjusted[*]]:FOR[zzzBluedog_DB_3]
{
	@mass *= #$@BDBRESCALECONFIG/apolloPodFactor$
	%bdbMassAdjusted = #$@BDBRESCALECONFIG/apolloPodFactor$
	%bdbSrbAdjusted = true
	
	@MODULE[ModuleEngines*],*
	{
		@maxThrust *= #$@BDBRESCALECONFIG/apolloPodFactor$
	}
	@RESOURCE[SolidFuel]
	{
		@amount *= #$@BDBRESCALECONFIG/apolloPodFactor$
		@maxAmount *= #$@BDBRESCALECONFIG/apolloPodFactor$
	}
}

@PART[bluedog_Apollo_Block*,bluedog_LEM*]:HAS[~bdbMassAdjusted[*]]:FOR[zzzBluedog_DB_3]
{
	@mass *= #$@BDBRESCALECONFIG/apolloPodFactor$
	%bdbMassAdjusted = #$@BDBRESCALECONFIG/apolloPodFactor$
}


// Saturn stage by stage

@PART[bluedog_Saturn_S1C_EngineMount,bluedog_Saturn_S2_Interstage]:HAS[~bdbMassAdjusted[*]]:FOR[zzzBluedog_DB_3]
{
	@mass *= #$@BDBRESCALECONFIG/ballastFactorS1C$
	%bdbMassAdjusted = #$@BDBRESCALECONFIG/ballastFactorS1C$
}

@PART[bluedog_Saturn_S2_EngineMount,bluedog_Saturn_S4B_WideInterstage]:HAS[~bdbMassAdjusted[*]]:FOR[zzzBluedog_DB_3]
{
	@mass *= #$@BDBRESCALECONFIG/ballastFactorS2$
	%bdbMassAdjusted = #$@BDBRESCALECONFIG/ballastFactorS2$
}

@PART[bluedog_Saturn_S4_EngineMount,bluedog_Saturn_S4_InstrumentUnit]:HAS[~bdbMassAdjusted[*]]:FOR[zzzBluedog_DB_3]
{
	@mass *= #$@BDBRESCALECONFIG/ballastFactorS4B$
	%bdbMassAdjusted = #$@BDBRESCALECONFIG/ballastFactorS4B$
}
@PART[bluedog_Saturn_S4B_APS,bluedog_Saturn_S4B_EngineMount,bluedog_Saturn_S4B_InstrumentUnit,bluedog_Saturn_S4B_SLA,bluedog_Saturn_S4B_SLA_Full]:HAS[~bdbMassAdjusted[*]]:FOR[zzzBluedog_DB_3]
{
	@mass *= #$@BDBRESCALECONFIG/ballastFactorS4B$
	
	@RESOURCE[MonoPropellant] // APS
	{
		@amount *= #$@BDBRESCALECONFIG/ballastFactorS4B$
		//@maxAmount *= #$@BDBRESCALECONFIG/ballastFactorS4B$
	}
	
	%bdbMassAdjusted = #$@BDBRESCALECONFIG/ballastFactorS4B$
}

// Agena D balloon tanks
@PART[bluedog_agenaLongTank]:HAS[#bdbSystemScale[>0],~bdbMassAdjusted[*]]:FOR[zzzBluedog_DB_3]
{
	@MODULE[ModuleB9PartSwitch]
	{
		@SUBTYPE,0
		{
			@name = Balloon
			@tankType = bdbBalloon
		}
	}
}

// Atlas balloon tanks
@PART[bluedog_atlas1*Tank,bluedog_atlasFairingAdapterTank]:HAS[#bdbSystemScale[>0],~bdbMassAdjusted[*]]:FOR[zzzBluedog_DB_3]
{
	@MODULE[ModuleB9PartSwitch]
	{
		@SUBTYPE,0
		{
			@name = Balloon
			@tankType = bdbBalloon
		}
	}
}

// Vega balloon tanks
@PART[bluedog_Vega*]:HAS[#bdbSystemScale[>0],~bdbMassAdjusted[*]]:FOR[zzzBluedog_DB_3]
{
	@MODULE[ModuleB9PartSwitch]
	{
		@SUBTYPE,0
		{
			@name = Balloon
			@tankType = bdbBalloon
		}
	}
}

// Bring solids up from 19% to 26% scale by mass.
@PART[bluedog_Delta_GEM*,bluedog_Diamant_*,bluedog_castorSRB,bluedog_alcyone,bluedog_Castor*,bluedog_star*,bluedog_Soltan_*,bluedog_Titan_SRB*]:HAS[#bdbSystemScale[>6],@RESOURCE[SolidFuel],~bdbMassAdjusted[*]]:FOR[zzzBluedog_DB_3]
{
	@mass *= 1.368
	@MODULE[ModuleEngines*]
	{
		@maxThrust *= 1.368
	}
	@RESOURCE[SolidFuel]
	{
		@amount *= 1.368
		@maxAmount *= 1.368
	}
}

//// Castor 30/120. Athena neeeds a little less dry mass in addition to basic adjustment
@PART[bluedog_Castor30,bluedog_Castor120]:HAS[#bdbSystemScale[>6],@RESOURCE[SolidFuel]]:FOR[zzzBluedog_DB_7]
{
	@mass *= 0.787
}

// ----


@PART[bluedog*,Bluedog*]:HAS[@MODULE[ModuleB9PartSwitch],~bdbMassAdjusted[*]]:FOR[zzzBluedog_DB_5]
{
	@mass -= #$extraMass$
	@mass *= #$@BDBRESCALECONFIG/tankFactor$
	@mass += #$extraMass$
	%bdbMassAdjusted = #$@BDBRESCALECONFIG/tankFactor$
	
	@MODULE[ModuleB9PartSwitch]
	{
		@SUBTYPE,*
		{
			@addedMass *= #$@BDBRESCALECONFIG/tankFactor$
		}
	}
}

@PART[bluedog*,Bluedog*]:HAS[@MODULE[ModuleProceduralFairing],~bdbMassAdjusted[*]]:FOR[zzzBluedog_DB_5]
{
	@mass *= #$@BDBRESCALECONFIG/structFactor$
	%bdbMassAdjusted = #$@BDBRESCALECONFIG/structFactor$
	@MODULE[ModuleProceduralFairing]
	{
		@UnitAreaMass *= #$@BDBRESCALECONFIG/structFactor$
	}
}

@PART[bluedog*,Bluedog*]:HAS[#CrewCapacity[>0],~bdbMassAdjusted[*]]:FOR[zzzBluedog_DB_5]
{
	@mass *= #$@BDBRESCALECONFIG/podFactor$
	%bdbMassAdjusted = #$@BDBRESCALECONFIG/podFactor$
}

@PART[bluedog*,Bluedog*]:HAS[@MODULE[ModuleCommand],#CrewCapacity[0],~bdbMassAdjusted[*]]:FOR[zzzBluedog_DB_5]
{
	@mass *= #$@BDBRESCALECONFIG/podFactor$
	%bdbMassAdjusted = #$@BDBRESCALECONFIG/podFactor$
}

@PART[bluedog*,Bluedog*]:HAS[@MODULE[ModuleEngines*]:HAS[@PROPELLANT[Oxidizer]],~bdbMassAdjusted[*]]:FOR[zzzBluedog_DB_5]
{
	@mass *= #$@BDBRESCALECONFIG/engineFactor$
	%bdbMassAdjusted = #$@BDBRESCALECONFIG/engineFactor$
	@MODULE[PartStatsUpgradeModule]
	{
		@UPGRADES
		{
			@UPGRADE,*
			{
				@PartStats
				{
					@mass *= #$@BDBRESCALECONFIG/engineFactor$
				}
			}
		}
	}
}

@PART[bluedog*,Bluedog*]:HAS[@MODULE[ModuleEngines*]:HAS[@PROPELLANT[SolidFuel]],~bdbMassAdjusted[*]]:FOR[zzzBluedog_DB_5]
{
	@mass *= #$@BDBRESCALECONFIG/tankFactor$
	%bdbMassAdjusted = #$@BDBRESCALECONFIG/tankFactor$
}

@PART[bluedog*,Bluedog*]:HAS[@MODULE[ModuleEngines*]:HAS[@PROPELLANT[SolidFuel]],~bdbSrbAdjusted[*]]:FOR[zzzBluedog_DB_5]
{
	%bdbSrbAdjusted = true
	@MODULE[ModuleEngines*]:HAS[@PROPELLANT[SolidFuel]],*
	{
		@atmosphereCurve
		{
			@key,0[1, ] += #$@BDBRESCALECONFIG/srbIspAdd$
			@key,1[1, ] += #$@BDBRESCALECONFIG/srbIspAdd$
		}
	}
}

@PART[bluedog*,Bluedog*]:HAS[#category[Coupling],~bdbMassAdjusted[*]]:FOR[zzzBluedog_DB_5]
{
	@mass *= #$@BDBRESCALECONFIG/structFactor$
	%bdbMassAdjusted = #$@BDBRESCALECONFIG/structFactor$
}


// Catchall
//@PART[bluedog*,Bluedog*]:HAS[~bdbMassAdjusted[*]]:FOR[zzzBluedog_DB_8]
//{
//	@mass *= #$@BDBRESCALECONFIG/structFactor$
//	%bdbMassAdjusted = true
//}

@PART[bluedog*,Bluedog*]:HAS[#bdbMassAdjusted[>0],@MODULE[ModuleRCS*]]:FOR[zzzBluedog_DB_8]
{
	@MODULE[ModuleRCS*]
	{
		@thrusterPower *= #$../bdbMassAdjusted$
	}
}


// ----


@PART[bluedog*,Bluedog*]:HAS[#bdbMassAdjusted[<1]]:FOR[zzzBluedog_DB_9]
{
	@description ^= :$:... Mass adjusted ...:
}

@PART[bluedog*,Bluedog*]:FOR[zzzBluedog_DB_9]
{
	!bdbMassAdjusted = delete
	!bdbSrbAdjusted = delete
	!bdbSystemScale = delete
}
